---
import { useTranslations } from '@i18n/utils';

const lang = Astro.currentLocale || 'fr';
const { t } = useTranslations(lang as 'fr' | 'en');
---

<section class="relative py-20 md:py-32 bg-background overflow-hidden" id="final-cta">
  <!-- Cyber Grid Background -->
  <div class="cyber-grid-light"></div>

  <div class="container-custom relative z-10">
    <!-- Section Badge -->
    <div class="text-center mb-8 fade-in-scroll">
      <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-cyan-500/30 backdrop-blur-sm mb-6">
        <span class="pulse-dot"></span>
        <span class="text-xs font-mono text-cyan-500 uppercase tracking-widest">{t('finalCta.badge')}</span>
      </div>
    </div>

    <!-- Terminal Window Container -->
    <div class="max-w-5xl mx-auto fade-in-scroll">
      <!-- Terminal Window -->
      <div class="terminal-window border border-border rounded-xl overflow-hidden bg-background/50 backdrop-blur-sm">
        <!-- Terminal Header Bar -->
        <div class="terminal-header flex items-center justify-between px-4 py-3 border-b border-border bg-grey-20/30">
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-red-500/80"></div>
            <div class="w-3 h-3 rounded-full bg-yellow-500/80"></div>
            <div class="w-3 h-3 rounded-full bg-cyan-500/80"></div>
          </div>
          <div class="text-xs font-mono text-muted-foreground">automx-cli v3.0.1</div>
          <div class="w-16"></div>
        </div>

        <!-- Terminal Content -->
        <div class="terminal-content p-6 md:p-8 lg:p-12 font-mono text-sm">
          <!-- Stats as Terminal Output -->
          <div class="mb-8 space-y-3">
            <div class="terminal-line">
              <span class="text-cyan-500">✓</span>
              <span class="text-muted-foreground ml-2">Checking system status...</span>
            </div>
            <div class="terminal-line flex flex-wrap gap-x-8 gap-y-2 ml-4">
              <div class="stat-inline">
                <span class="text-cyan-500 font-bold stat-number" data-target="150">
                  <span class="counter">0</span>+
                </span>
                <span class="text-muted-foreground/70 text-xs ml-1">projects delivered</span>
              </div>
              <div class="stat-inline">
                <span class="text-cyan-500 font-bold stat-number" data-target="98">
                  <span class="counter">0</span>%
                </span>
                <span class="text-muted-foreground/70 text-xs ml-1">satisfaction</span>
              </div>
              <div class="stat-inline">
                <span class="text-cyan-500 font-bold stat-number" data-target="24">
                  <span class="counter">0</span>/7
                </span>
                <span class="text-muted-foreground/70 text-xs ml-1">support</span>
              </div>
              <div class="stat-inline">
                <span class="text-cyan-500 font-bold stat-number" data-target="5">
                  <span class="counter">0</span>★
                </span>
                <span class="text-muted-foreground/70 text-xs ml-1">rating</span>
              </div>
            </div>
          </div>

          <!-- Main Message -->
          <div class="mb-8 border-l-2 border-cyan-500 pl-4 py-2">
            <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold mb-3 text-foreground">
              {t('finalCta.title')}
            </h2>
            <p class="text-sm md:text-base text-muted-foreground leading-relaxed">
              {t('finalCta.subtitle')}
            </p>
          </div>

          <!-- Command Actions -->
          <div class="space-y-3 mb-6">
            <!-- Command 1: Start Project -->
            <div class="terminal-command-line group">
              <span class="text-cyan-500">$</span>
              <span class="text-muted-foreground ml-2">automx</span>
              <a
                href={lang === 'fr' ? '/contact' : '/en/contact'}
                class="scramble-btn inline-flex items-center ml-2 px-6 py-3 bg-cyan-500 hover:bg-cyan-400 text-white font-bold uppercase tracking-wider transition-all duration-300 clip-corner-btn gap-2"
              >
                <span class="scramble-text" data-text={t('finalCta.button')}>{t('finalCta.button')}</span>
                <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                </svg>
              </a>
            </div>

            <!-- Command 2: Schedule Call -->
            <div class="terminal-command-line group">
              <span class="text-cyan-500">$</span>
              <span class="text-muted-foreground ml-2">automx</span>
              <button
                class="scramble-btn inline-flex items-center ml-2 px-6 py-3 border-2 border-border hover:border-cyan-500 text-foreground hover:text-cyan-500 font-bold uppercase tracking-wider transition-all duration-300 clip-corner-btn gap-2"
              >
                <span class="scramble-text" data-text={t('finalCta.schedule_call')}>{t('finalCta.schedule_call')}</span>
                <svg class="w-4 h-4 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- Contact Info as Terminal Output -->
          <div class="pt-4 border-t border-border/30 space-y-2 text-xs">
            <div class="flex items-center gap-2 text-muted-foreground/60">
              <span class="text-cyan-500">→</span>
              <span>contact@automx.com</span>
            </div>
            <div class="flex items-center gap-2 text-muted-foreground/60">
              <span class="text-cyan-500">→</span>
              <span>Response within 24h</span>
            </div>
          </div>

          <!-- Blinking Cursor -->
          <div class="mt-6 flex items-center">
            <span class="text-cyan-500">$</span>
            <span class="terminal-cursor ml-2">_</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* Terminal cursor animation */
  .terminal-cursor {
    animation: blink 1s infinite;
    color: rgba(14, 165, 233, 0.8);
  }

  @keyframes blink {
    0%, 49% { opacity: 1; }
    50%, 100% { opacity: 0; }
  }

  /* Terminal window styling */
  .terminal-window {
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  .terminal-window:hover {
    box-shadow: 0 12px 48px rgba(14, 165, 233, 0.2);
    border-color: rgba(14, 165, 233, 0.4);
  }

  /* Clip corner for buttons */
  .clip-corner-btn {
    clip-path: polygon(
      0 0,
      calc(100% - 8px) 0,
      100% 8px,
      100% 100%,
      0 100%
    );
  }

  /* Terminal command line */
  .terminal-command-line {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  /* Stats glow effect */
  .stat-number {
    text-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .terminal-command-line {
      flex-direction: column;
      align-items: flex-start;
    }

    .terminal-command-line button,
    .terminal-command-line a {
      width: 100%;
      justify-content: center;
    }
  }
</style>

<script>
  // Counter animation for stats
  function animateCounter(element: HTMLElement, target: number) {
    const counter = element.querySelector('.counter') as HTMLElement;
    if (!counter) return;

    const duration = 2000;
    const start = 0;
    const startTime = Date.now();

    function update() {
      const elapsed = Date.now() - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const current = Math.floor(start + (target - start) * progress);

      counter.textContent = current.toString();

      if (progress < 1) {
        requestAnimationFrame(update);
      }
    }

    update();
  }

  // Scramble text effect
  function scrambleText(element: HTMLElement, finalText: string) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
    const duration = 600;
    const startTime = Date.now();

    function update() {
      const elapsed = Date.now() - startTime;
      const progress = Math.min(elapsed / duration, 1);

      let result = '';
      for (let i = 0; i < finalText.length; i++) {
        if (progress * finalText.length > i) {
          result += finalText[i];
        } else {
          result += chars[Math.floor(Math.random() * chars.length)];
        }
      }

      element.textContent = result;

      if (progress < 1) {
        requestAnimationFrame(update);
      } else {
        element.textContent = finalText;
      }
    }

    update();
  }

  // Observe stats and trigger animation when visible
  document.addEventListener('DOMContentLoaded', () => {
    const statNumbers = document.querySelectorAll('.stat-number');
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const target = parseInt(entry.target.getAttribute('data-target') || '0');
          animateCounter(entry.target as HTMLElement, target);
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.5 });

    statNumbers.forEach(stat => observer.observe(stat));

    // Add scramble effect on hover to all buttons
    document.querySelectorAll('.scramble-btn').forEach(button => {
      button.addEventListener('mouseenter', () => {
        const textEl = button.querySelector('.scramble-text') as HTMLElement;
        if (textEl) {
          const text = textEl.getAttribute('data-text') || '';
          scrambleText(textEl, text);
        }
      });
    });
  });
</script>
